services:
  app:
    profiles:
      - app
      - production
    build: .
    image: vz-wiki-frontend-local
    ports:
      - "3001:8080"
    env_file:
      - .env.prod
    environment:
      AWS_PROFILE: mfa-session
      AWS_SDK_LOAD_CONFIG: "1"
      AWS_REGION: ap-southeast-1
    volumes:
      - ~/.aws:/root/.aws:ro
  app-dev:
    profiles:
      - app-dev
      - development
    image: node:20-alpine
    working_dir: /app
    # Mount your source into the container so changes are live
    volumes:
      - .:/app
      # keep node_modules inside container so host/ARM vs container binaries don't fight
      - /app/node_modules
      - ~/.aws:/root/.aws:ro
    environment:
      NODE_ENV: development
      APP_ENV: development
      AWS_REGION: ap-southeast-1
      AWS_PROFILE: mfa-session
      AWS_SDK_LOAD_CONFIG: "1"
      AWS_DEFAULT_REGION: ap-southeast-1
    env_file:
      - ./.env.local
    command: sh -c "if [ ! -d node_modules ]; then npm install; fi && npm run dev -- --hostname 0.0.0.0 --port 3001"
    ports:
      - "3001:3001"
  app-uat:
    profiles:
      - app-uat
      - uat
    image: node:20-alpine
    working_dir: /app
    # Mount your source into the container so changes are live
    volumes:
      - .:/app
      # keep node_modules inside container so host/ARM vs container binaries don't fight
      - /app/node_modules
      - ~/.aws:/root/.aws:ro
    environment:
      NODE_ENV: development
      APP_ENV: uat
      AWS_REGION: ap-southeast-1
      AWS_PROFILE: mfa-session
      AWS_SDK_LOAD_CONFIG: "1"
      AWS_DEFAULT_REGION: ap-southeast-1
      # UAT should not default to prod bucket
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-vz-internal-ai-prod}
    env_file:
      - ./.env.uat
    command: sh -c "if [ ! -d node_modules ] || [ ! -f node_modules/.bin/next ]; then npm install; fi && npm run dev -- --hostname 0.0.0.0 --port 3001"
    ports:
      - "3001:3001"